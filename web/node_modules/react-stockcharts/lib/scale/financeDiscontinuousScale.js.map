{"version":3,"sources":["../../../src/lib/scale/financeDiscontinuousScale.js"],"names":["financeDiscontinuousScale","MAX_LEVEL","length","index","futureProvider","backingLinearScale","Error","scale","x","invert","inverted","Math","round","domain","arguments","range","rangeRound","clamp","interpolate","ticks","m","flexTicks","backingTicks","ticksMap","domainStart","domainEnd","start","max","ceil","abs","end","min","floor","desiredTickCount","i","ticksAtLevel","get","temp","slice","j","level","push","set","unsortedTicks","concat","map","d","sort","ticksSet","distance","remove","tickValues","values","parseInt","tickFormat","format","date","value","nice","copy"],"mappings":"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","file":"financeDiscontinuousScale.js","sourcesContent":["\n\nimport { set, map } from \"d3-collection\";\nimport { ascending } from \"d3-array\";\nimport { scaleLinear } from \"d3-scale\";\n\nimport { isDefined, isNotDefined, head, last } from \"../utils\";\nimport { levelDefinition } from \"./levels\";\n\nconst MAX_LEVEL = levelDefinition.length - 1;\n\nexport default function financeDiscontinuousScale(\n\tindex,\n\tfutureProvider,\n\tbackingLinearScale = scaleLinear()\n) {\n\n\tif (isNotDefined(index))\n\t\tthrow new Error(\"Use the discontinuousTimeScaleProvider to create financeDiscontinuousScale\");\n\n\tfunction scale(x) {\n\t\treturn backingLinearScale(x);\n\t}\n\tscale.invert = function(x) {\n\t\tconst inverted = backingLinearScale.invert(x);\n\t\treturn Math.round(inverted * 10000) / 10000;\n\t};\n\tscale.domain = function(x) {\n\t\tif (!arguments.length) return backingLinearScale.domain();\n\t\tbackingLinearScale.domain(x);\n\t\treturn scale;\n\t};\n\tscale.range = function(x) {\n\t\tif (!arguments.length) return backingLinearScale.range();\n\t\tbackingLinearScale.range(x);\n\t\treturn scale;\n\t};\n\tscale.rangeRound = function(x) {\n\t\treturn backingLinearScale.range(x);\n\t};\n\tscale.clamp = function(x) {\n\t\tif (!arguments.length) return backingLinearScale.clamp();\n\t\tbackingLinearScale.clamp(x);\n\t\treturn scale;\n\t};\n\tscale.interpolate = function(x) {\n\t\tif (!arguments.length) return backingLinearScale.interpolate();\n\t\tbackingLinearScale.interpolate(x);\n\t\treturn scale;\n\t};\n\tscale.ticks = function(m, flexTicks) {\n\t\tconst backingTicks = backingLinearScale.ticks(m);\n\t\tconst ticksMap = map();\n\n\t\tconst [domainStart, domainEnd] = backingLinearScale.domain();\n\n\t\tconst start = Math.max(Math.ceil(domainStart), head(index).index) + Math.abs(head(index).index);\n\t\tconst end = Math.min(Math.floor(domainEnd), last(index).index) + Math.abs(head(index).index);\n\n\t\tif (Math.floor(domainEnd) > end) {\n\t\t\t// console.log(end, domainEnd, index);\n\t\t}\n\n\t\tconst desiredTickCount = Math.ceil((end - start) / (domainEnd - domainStart) * backingTicks.length);\n\n\t\tfor (let i = MAX_LEVEL; i >= 0; i--) {\n\t\t\tconst ticksAtLevel = ticksMap.get(i);\n\t\t\tconst temp = isNotDefined(ticksAtLevel)\n\t\t\t\t? []\n\t\t\t\t: ticksAtLevel.slice();\n\n\t\t\tfor (let j = start; j <= end; j++) {\n\t\t\t\tif (index[j].level === i) {\n\t\t\t\t\ttemp.push(index[j]);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tticksMap.set(i, temp);\n\t\t}\n\n\t\tlet unsortedTicks = [];\n\t\tfor (let i = MAX_LEVEL; i >= 0; i--) {\n\t\t\tif ((ticksMap.get(i).length + unsortedTicks.length) > desiredTickCount * 1.5) break;\n\t\t\tunsortedTicks = unsortedTicks.concat(ticksMap.get(i).map(d => d.index));\n\t\t}\n\n\t\tconst ticks = unsortedTicks.sort(ascending);\n\n\t\t// console.log(backingTicks.length, desiredTickCount, ticks, ticksMap);\n\n\t\tif (!flexTicks && end - start > ticks.length) {\n\t\t\tconst ticksSet = set(ticks);\n\n\t\t\tconst d = Math.abs(head(index).index);\n\n\t\t\t// ignore ticks within this distance\n\t\t\tconst distance = Math.ceil(\n\t\t\t\t(backingTicks.length > 0\n\t\t\t\t\t? (last(backingTicks) - head(backingTicks)) / (backingTicks.length) / 4\n\t\t\t\t\t: 1) * 1.5);\n\n\t\t\tfor (let i = 0; i < ticks.length - 1; i++) {\n\t\t\t\tfor (let j = i + 1; j < ticks.length; j++) {\n\t\t\t\t\tif (ticks[j] - ticks[i] <= distance) {\n\t\t\t\t\t\tticksSet.remove(index[ticks[i] + d].level >= index[ticks[j] + d].level ? ticks[j] : ticks[i]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst tickValues = ticksSet.values().map(d => parseInt(d, 10));\n\n\t\t\t// console.log(ticks.length, tickValues, level);\n\t\t\t// console.log(ticks, tickValues, distance);\n\n\t\t\treturn tickValues;\n\t\t}\n\n\t\treturn ticks;\n\t};\n\tscale.tickFormat = function() {\n\t\treturn function(x) {\n\t\t\tconst d = Math.abs(head(index).index);\n\t\t\tconst { format, date } = index[Math.floor(x + d)];\n\t\t\treturn format(date);\n\t\t};\n\t};\n\tscale.value = function(x) {\n\t\tconst d = Math.abs(head(index).index);\n\t\tif (isDefined(index[Math.floor(x + d)])) {\n\t\t\tconst { date } = index[Math.floor(x + d)];\n\t\t\treturn date;\n\t\t}\n\t};\n\tscale.nice = function(m) {\n\t\tbackingLinearScale.nice(m);\n\t\treturn scale;\n\t};\n\tscale.index = function(x) {\n\t\tif (!arguments.length) return index;\n\t\tindex = x;\n\t\treturn scale;\n\t};\n\tscale.copy = function() {\n\t\treturn financeDiscontinuousScale(index, futureProvider, backingLinearScale.copy());\n\t};\n\treturn scale;\n}"]}