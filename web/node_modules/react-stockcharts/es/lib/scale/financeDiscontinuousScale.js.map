{"version":3,"sources":["../../../../src/lib/scale/financeDiscontinuousScale.js"],"names":["set","map","ascending","scaleLinear","isDefined","isNotDefined","head","last","levelDefinition","MAX_LEVEL","length","financeDiscontinuousScale","index","futureProvider","backingLinearScale","Error","scale","x","invert","inverted","Math","round","domain","arguments","range","rangeRound","clamp","interpolate","ticks","m","flexTicks","backingTicks","ticksMap","domainStart","domainEnd","start","max","ceil","abs","end","min","floor","desiredTickCount","i","ticksAtLevel","get","temp","slice","j","level","push","unsortedTicks","concat","d","sort","ticksSet","distance","remove","tickValues","values","parseInt","tickFormat","format","date","value","nice","copy"],"mappings":"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","file":"financeDiscontinuousScale.js","sourcesContent":["\n\nimport { set, map } from \"d3-collection\";\nimport { ascending } from \"d3-array\";\nimport { scaleLinear } from \"d3-scale\";\n\nimport { isDefined, isNotDefined, head, last } from \"../utils\";\nimport { levelDefinition } from \"./levels\";\n\nconst MAX_LEVEL = levelDefinition.length - 1;\n\nexport default function financeDiscontinuousScale(\n\tindex,\n\tfutureProvider,\n\tbackingLinearScale = scaleLinear()\n) {\n\n\tif (isNotDefined(index))\n\t\tthrow new Error(\"Use the discontinuousTimeScaleProvider to create financeDiscontinuousScale\");\n\n\tfunction scale(x) {\n\t\treturn backingLinearScale(x);\n\t}\n\tscale.invert = function(x) {\n\t\tconst inverted = backingLinearScale.invert(x);\n\t\treturn Math.round(inverted * 10000) / 10000;\n\t};\n\tscale.domain = function(x) {\n\t\tif (!arguments.length) return backingLinearScale.domain();\n\t\tbackingLinearScale.domain(x);\n\t\treturn scale;\n\t};\n\tscale.range = function(x) {\n\t\tif (!arguments.length) return backingLinearScale.range();\n\t\tbackingLinearScale.range(x);\n\t\treturn scale;\n\t};\n\tscale.rangeRound = function(x) {\n\t\treturn backingLinearScale.range(x);\n\t};\n\tscale.clamp = function(x) {\n\t\tif (!arguments.length) return backingLinearScale.clamp();\n\t\tbackingLinearScale.clamp(x);\n\t\treturn scale;\n\t};\n\tscale.interpolate = function(x) {\n\t\tif (!arguments.length) return backingLinearScale.interpolate();\n\t\tbackingLinearScale.interpolate(x);\n\t\treturn scale;\n\t};\n\tscale.ticks = function(m, flexTicks) {\n\t\tconst backingTicks = backingLinearScale.ticks(m);\n\t\tconst ticksMap = map();\n\n\t\tconst [domainStart, domainEnd] = backingLinearScale.domain();\n\n\t\tconst start = Math.max(Math.ceil(domainStart), head(index).index) + Math.abs(head(index).index);\n\t\tconst end = Math.min(Math.floor(domainEnd), last(index).index) + Math.abs(head(index).index);\n\n\t\tif (Math.floor(domainEnd) > end) {\n\t\t\t// console.log(end, domainEnd, index);\n\t\t}\n\n\t\tconst desiredTickCount = Math.ceil((end - start) / (domainEnd - domainStart) * backingTicks.length);\n\n\t\tfor (let i = MAX_LEVEL; i >= 0; i--) {\n\t\t\tconst ticksAtLevel = ticksMap.get(i);\n\t\t\tconst temp = isNotDefined(ticksAtLevel)\n\t\t\t\t? []\n\t\t\t\t: ticksAtLevel.slice();\n\n\t\t\tfor (let j = start; j <= end; j++) {\n\t\t\t\tif (index[j].level === i) {\n\t\t\t\t\ttemp.push(index[j]);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tticksMap.set(i, temp);\n\t\t}\n\n\t\tlet unsortedTicks = [];\n\t\tfor (let i = MAX_LEVEL; i >= 0; i--) {\n\t\t\tif ((ticksMap.get(i).length + unsortedTicks.length) > desiredTickCount * 1.5) break;\n\t\t\tunsortedTicks = unsortedTicks.concat(ticksMap.get(i).map(d => d.index));\n\t\t}\n\n\t\tconst ticks = unsortedTicks.sort(ascending);\n\n\t\t// console.log(backingTicks.length, desiredTickCount, ticks, ticksMap);\n\n\t\tif (!flexTicks && end - start > ticks.length) {\n\t\t\tconst ticksSet = set(ticks);\n\n\t\t\tconst d = Math.abs(head(index).index);\n\n\t\t\t// ignore ticks within this distance\n\t\t\tconst distance = Math.ceil(\n\t\t\t\t(backingTicks.length > 0\n\t\t\t\t\t? (last(backingTicks) - head(backingTicks)) / (backingTicks.length) / 4\n\t\t\t\t\t: 1) * 1.5);\n\n\t\t\tfor (let i = 0; i < ticks.length - 1; i++) {\n\t\t\t\tfor (let j = i + 1; j < ticks.length; j++) {\n\t\t\t\t\tif (ticks[j] - ticks[i] <= distance) {\n\t\t\t\t\t\tticksSet.remove(index[ticks[i] + d].level >= index[ticks[j] + d].level ? ticks[j] : ticks[i]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst tickValues = ticksSet.values().map(d => parseInt(d, 10));\n\n\t\t\t// console.log(ticks.length, tickValues, level);\n\t\t\t// console.log(ticks, tickValues, distance);\n\n\t\t\treturn tickValues;\n\t\t}\n\n\t\treturn ticks;\n\t};\n\tscale.tickFormat = function() {\n\t\treturn function(x) {\n\t\t\tconst d = Math.abs(head(index).index);\n\t\t\tconst { format, date } = index[Math.floor(x + d)];\n\t\t\treturn format(date);\n\t\t};\n\t};\n\tscale.value = function(x) {\n\t\tconst d = Math.abs(head(index).index);\n\t\tif (isDefined(index[Math.floor(x + d)])) {\n\t\t\tconst { date } = index[Math.floor(x + d)];\n\t\t\treturn date;\n\t\t}\n\t};\n\tscale.nice = function(m) {\n\t\tbackingLinearScale.nice(m);\n\t\treturn scale;\n\t};\n\tscale.index = function(x) {\n\t\tif (!arguments.length) return index;\n\t\tindex = x;\n\t\treturn scale;\n\t};\n\tscale.copy = function() {\n\t\treturn financeDiscontinuousScale(index, futureProvider, backingLinearScale.copy());\n\t};\n\treturn scale;\n}"]}